import { reactive } from 'vue';
import { defineStore } from 'pinia';
import { SetupStoreId } from '@/enum';

// 定义类型
interface ProcessedJson {
  patientId: string;
  data: Record<string, any>;
  source: Record<string, any>;
  source_pattern: Record<string, any>;
  doctor_pattern: Record<string, any>;
  patient?: Record<string, any>;
  doctor?: Record<string, any>;
  patient_new?: Record<string, any>;
  doctor_new?: Record<string, any>;
}

interface PromptData {
  section_contents: Record<string, any>;
  section_columns: Record<string, any>;
  logic_type?: Record<string, any>;
}

export const useTaskStore = defineStore(SetupStoreId.Task, () => {
  const processedJson = reactive<ProcessedJson>({
    patientId: '',
    data: {},
    source: {
      姓名: {},
      性别: {},
      年龄: {},
      住院号: {},
      床号: {},
      科室: {},
      入院时间: {},
      出院时间: {},
      低压: {},
      高压: {},
      脉搏: {},
      呼吸: {},
      体温: {},
      入院诊断: {},
      出院诊断: {},
      体检摘要: {},
      入院时简要病史: {},
      住院期间医疗情况: {},
      病程与治疗情况: {},
      出院后用药建议: {},
      出院时情况: {}
    },
    source_pattern: {
      姓名: ['测试病人0279'],
      性别: ['女'],
      年龄: ['年龄:27'],
      住院号: ['z83531'],
      床号: ['8551'],
      科室: ['乳腺外科一'],
      入院时间: ['2019-01-03'],
      出院时间: ['2019-01-04', '出院'],
      低压: ['120/70 mmHg'],
      高压: ['120/70 mmHg'],
      脉搏: ['72 次/分'],
      呼吸: ['16 次/分'],
      体温: ['36.8 ℃'],
      入院诊断: ['乳房肿块(右乳)'],
      出院诊断: ['乳房良性肿瘤(右乳待石蜡)'],
      体检摘要: [
        [
          '查体:双乳对称；双乳皮肤无红肿、破溃、凹陷、橘皮样变；双侧乳头等高、无凹陷、无歪斜，无乳头湿疹样改变，未见陈旧手术疤痕；右乳外下可扪及一直径约2cm肿块，质地硬，活动度好，边界清楚，肿块与皮肤无粘连，无明显触痛。'
        ],
        ['无乳头溢液。'],
        ['对侧乳腺未及明确肿块。'],
        ['双侧腋窝及双侧锁骨上不可扪及异常肿大淋巴结。']
      ],
      入院时简要病史: [
        ['患者3个月前体检发现右乳一肿物，大小约2cm。'],
        ['活动度好，无压痛，无乳房局部皮肤破溃红肿，皮肤无变薄，皮下未见扩张静脉，乳头皮肤无湿疹样改变。'],
        ['无乳头溢液。'],
        [
          '2019-1-3患者至我院门诊就诊，乳腺B超提示:右侧乳腺可见一低回声，位于约8点钟方向腺体边缘，大小约24×13mm，水平位生长，呈分叶状，拟US-BI-RADS 3类。'
        ],
        ['本次为行进一步诊治，门诊拟"右乳肿物"收治入院。'],
        ['自发病以来，患者神清，精神可，睡眠胃纳可，二便正常，体重无明显增减。']
      ],
      住院期间医疗情况: [
        ['APTT:34.6秒,正常;', 'PT:11.8秒,正常;', 'INR:1.00;'],
        ['血小板平均体积:10.6fl,正常;', '血小板计数:366×10^9/L,偏高;', '嗜酸性粒细胞%:0.4％,偏低;'],
        [
          '平均血红蛋白量:29.7pg,正常;',
          '血小板平均体积:12.7fl,偏高;',
          '血小板计数:203×10^9/L,正常;',
          '红细胞分布宽度:12.4％,正常;',
          '平均血红蛋白浓度:341g/L,正常;',
          '平均红细胞体积:87.1fl,正常;',
          '白细胞计数:5.38x10^9/L,正常;',
          '红细胞比容:0.460,正常;',
          '血红蛋白:157g/L,正常;',
          '红细胞计数:5.28×10^12/L,正常;',
          '单核细胞计数:0.34×10^9/L,正常;',
          '嗜碱性粒细胞计数:0.03×10^9/L,正常;',
          '嗜酸性粒细胞计数:0.08×10^9/L,正常;',
          '淋巴细胞计数:1.89×10^9/L,正常;',
          '中性粒细胞计数:3.04×10^9/L,正常;',
          '嗜碱性粒细胞%:0.6％,正常;',
          '嗜酸性粒细胞%:1.5％,正常;',
          '单核细胞%:6.3％,正常;',
          '淋巴细胞%:35.1％,正常;',
          '中性粒细胞%:56.5％,正常;'
        ],
        [
          '磷:1.11mmol/L,正常;',
          '钠:141mmol/L,正常;',
          '钾:4.29mmol/L,正常;',
          '肌酐:51μmol/L,偏低;',
          '丙氨酸氨基转移酶:9IU/L,偏低;',
          '二氧化碳:28.1mmol/L,正常;',
          '氯:104mmol/L,正常;',
          '钙:2.42mmol/L,正常;'
        ]
      ],
      病程与治疗情况: [
        ['患者于2019-01-03在全麻下行右乳肿物切除术。'],
        ['手术顺利，术后安返病房。'],
        ['术后给予抗炎、止血等对症治疗。'],
        ['患者恢复良好，于2019-01-04出院。']
      ],
      出院后用药建议: [
        ['1. 继续口服抗生素3天。'],
        ['2. 伤口保持清洁干燥，避免沾水。'],
        ['3. 术后1周门诊复查。'],
        ['4. 如有发热、伤口红肿等异常情况及时就诊。']
      ],
      出院时情况: [
        ['患者一般情况良好，精神可，饮食睡眠正常。'],
        ['伤口愈合良好，无红肿、渗液。'],
        ['体温正常，无发热。'],
        ['患者对治疗满意，依从性良好。']
      ]
    },
    doctor_pattern: {}
  });

  const prompt = {
    logic_prompts: {
      患者基本信息:
        '请参照患者的医疗资料，编写其出院小结文书的"患者基本信息"字段部分。请确保输出遵守标准json格式，并包含字段"住院号"、"床号"、"入院时间"、"出院时间"、"科别"、"科室"、"姓名"、"年龄"、"性别"、"低压(BP低)"、"高压(BP高)"、"脉搏(P)"、"呼吸(R)"、"体温(T)"、"入院诊断"、"入院时简要病史"、"体检摘要"。',
      出院诊断:
        '从提供的患者医疗记录中，抽取并撰写出院小结的"出院诊断"内容。请以文本格式输出。\n字段介绍:分析患者的诊断和病程记录，输出患者的出院诊断，名称应为标准诊断术语，若有相关的描述信息，在括号内注明。',
      住院期间医疗情况:
        '请根据上述的患者信息，撰写出院小结中"住院期间医疗情况"字段信息。使用文本格式输出。\n字段介绍:对患者的检查和检验信息进行综合分析，输出患者所有的检验和检查信息。',
      病程与治疗情况:
        '请根据上述患者信息编写出院小结中"病程与治疗情况"字段。请按标准的文本格式输出。\n字段介绍:对患者的住院病程数据进行分析，集中呈现其在医院期间接受的主要治疗方式，包括手术、化疗、报告及当前情况等信息。',
      出院时情况:
        '请根据上述的患者信息，撰写出院小结中"出院时情况"字段信息。输出应为一段文本。\n字段介绍:从患者病历中提取关键信息，以明确其出院时的总体健康情况，如精神状况、身体恢复情况等。',
      出院后用药建议:
        '根据患者的医疗档案，请填写其出院小结中的"出院后用药建议"字段信息。使用文本格式输出。\n字段介绍:建议以有序列表形式组织输出内容，每条建议前应添加序号，例如\'1.\' , \'2.\' , \'3.\'等，以便于阅读和理解各项指示。\n撰写建议:请先检查患者报告是否出齐；针对患者的出院带药进行描述；随后，阐述患者应注意的伤口处理；对患者的复诊与换药提供指示；对患者在检验检查中的异常情况、以及患者的其他诊断进行随诊与随访建议；若患者有置管，应提醒拔管前后的注意事项。'
    },
    section_contents: {
      患者基本信息: {
        姓名: '测试病人0279',
        性别: '女',
        年龄: '27',
        住院号: 'z83531',
        床号: '8551',
        科室: '乳腺外科一',
        入院时间: '2019-01-03',
        出院时间: '2019-01-04',
        低压: '70 mmHg',
        高压: '120 mmHg',
        脉搏: '72 次/分',
        呼吸: '16 次/分',
        体温: '36.8 ℃',
        入院诊断: '乳房肿块(右乳)',
        入院时简要病史:
          '患者3个月前体检发现右乳一肿物，大小约2cm。活动度好，无压痛，无乳房局部皮肤破溃红肿，皮肤无变薄，皮下未见扩张静脉，乳头皮肤无湿疹样改变。无乳头溢液。2019-1-3患者至我院门诊就诊，乳腺B超提示:右侧乳腺可见一低回声，位于约8点钟方向腺体边缘，大小约24×13mm，水平位生长，呈分叶状，拟US-BI-RADS 3类。本次为行进一步诊治，门诊拟"右乳肿物"收治入院。自发病以来，患者神清，精神可，睡眠胃纳可，二便正常，体重无明显增减。',
        体检摘要:
          '查体：双乳对称；双乳皮肤无红肿、破溃、凹陷、橘皮样变；双侧乳头等高、无凹陷、无歪斜，无乳头湿疹样改变，未见陈旧手术疤痕；右乳外下可扪及一直径约2cm肿块，质地硬，活动度好，边界清楚，肿块与皮肤无粘连，无明显触痛。无溢液。双侧腋窝及双侧锁骨上不可扪及异常肿大淋巴结。'
      },
      出院诊断: {
        出院诊断: '乳房良性肿瘤(右乳待石蜡)'
      },
      住院期间医疗情况: {
        检验结果:
          '血常规：白细胞计数5.38×10^9/L，红细胞计数5.28×10^12/L，血红蛋白157g/L，血小板计数203×10^9/L。凝血功能：APTT 34.6秒，PT 11.8秒，INR 1.00。生化检查：钾4.29mmol/L，钠141mmol/L，氯104mmol/L，钙2.42mmol/L，磷1.11mmol/L，肌酐51μmol/L，丙氨酸氨基转移酶9IU/L。',
        检查结果:
          '乳腺B超：右侧乳腺可见一低回声，位于约8点钟方向腺体边缘，大小约24×13mm，水平位生长，呈分叶状，拟US-BI-RADS 3类，首先考虑纤维腺瘤，已定位。'
      },
      病程与治疗情况: {
        治疗经过:
          '患者于2019-01-03在全麻下行右乳肿物切除术。手术顺利，术后安返病房。术后给予抗炎、止血等对症治疗。患者恢复良好，于2019-01-04出院。',
        手术情况:
          '手术名称：右乳肿物切除术\n手术日期：2019-01-03\n麻醉方式：全麻\n手术顺利，无并发症'
      },
      出院时情况: {
        一般情况: '患者一般情况良好，精神可，饮食睡眠正常。',
        伤口情况: '伤口愈合良好，无红肿、渗液。',
        生命体征: '体温正常，无发热。',
        其他: '患者对治疗满意，依从性良好。'
      },
      出院后用药建议: {
        用药建议: [
          '1. 继续口服抗生素3天。',
          '2. 伤口保持清洁干燥，避免沾水。',
          '3. 术后1周门诊复查。',
          '4. 如有发热、伤口红肿等异常情况及时就诊。'
        ]
      }
    },
    section_columns: {
      患者基本信息: [
        '姓名',
        '性别',
        '年龄',
        '住院号',
        '床号',
        '科室',
        '入院时间',
        '出院时间',
        '低压',
        '高压',
        '脉搏',
        '呼吸',
        '体温',
        '入院诊断',
        '入院时简要病史',
        '体检摘要'
      ],
      出院诊断: ['出院诊断'],
      住院期间医疗情况: ['检验结果', '检查结果'],
      病程与治疗情况: ['治疗经过', '手术情况'],
      出院时情况: ['一般情况', '伤口情况', '生命体征', '其他'],
      出院后用药建议: ['用药建议']
    },
    logic_type: {
      患者基本信息: {
        抽取: ['姓名、性别、年龄、住院号、床号、病区名称、入院日期、体温、心率、呼吸、高低压', '入院诊断'],
        推理: ['出院时间'],
        摘要: ['查体、简要病史']
      },
      出院诊断: {
        抽取: ['出院时的诊断信息']
      },
      住院期间医疗情况: {
        抽取: ['检验和检查信息']
      },
      病程与治疗情况: {
        判断: ['治疗过程中是否进行了手术'],
        抽取: ['手术日期、麻醉方式、手术名称、术中术后病理情况、术后用药情况'],
        推理: ['分析患者的恢复情况，如引流管状态、于何日出院，推理出院时的总体情况']
      },
      出院时情况: {
        摘要: ['出院时的总体健康情况，如精神状况、身体恢复情况等。']
      },
      出院后用药建议: {
        判断: ['判断患者报告是否出齐'],
        抽取: ['出院带药、复诊与换药信息'],
        知识: ['如果有慢性疾病/异常检验检查，则与知识库匹配，得到科室随访建议。']
      }
    }
  };

  function setProcessedJson(jsonData: object) {
    Object.assign(processedJson, jsonData);
  }

  function getProcessedJson() {
    return processedJson;
  }

  function getPatientData() {
    return processedJson.data;
  }

  function setPatientData(data: object) {
    Object.assign(processedJson.data, data);
  }

  function getPatientId() {
    return processedJson.patientId;
  }

  function setPatientId(patientId: string) {
    processedJson.patientId = patientId;
  }

  function setPrompt(jsonData: object) {
    Object.assign(prompt, jsonData);
  }

  function getPrompt() {
    return prompt;
  }

  function setSection(jsonData: PromptData) {
    Object.assign(prompt.section_contents, jsonData.section_contents);
    Object.assign(prompt.section_columns, jsonData.section_columns);
  }

  function setDischargeSummary(jsonData: any) {
    if (jsonData.source) {
      Object.assign(processedJson.source, jsonData.source);
    }
    if (jsonData.source_pattern) {
      Object.assign(processedJson.source_pattern, jsonData.source_pattern);
    }
    if (jsonData.patient_new) {
      processedJson.patient_new = jsonData.patient_new;
    }
    if (jsonData.doctor_new) {
      processedJson.doctor_new = jsonData.doctor_new;
    }
    if (jsonData.doctor_pattern) {
      Object.assign(processedJson.doctor_pattern, jsonData.doctor_pattern);
    }
  }

  return {
    processedJson,
    setProcessedJson,
    getProcessedJson,
    setPatientId,
    getPatientId,
    setPatientData,
    getPatientData,
    prompt,
    setPrompt,
    getPrompt,
    setSection,
    setDischargeSummary
  };
});
